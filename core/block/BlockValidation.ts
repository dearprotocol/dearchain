// Validate Block

import { RawTransaction } from "../../interfaces/Transaction";
import { TransactionPoolDB } from "../../packages/db/memory/transactionpool";
import { calculateHash } from "../transaction/TransactionSigning";
import { validateSignature, validateTransfer } from "../transaction/TransactionValidation";
import secp256k1 from "secp256k1";
import { SHA3 } from "sha3";
import { convertToHex, getAddress } from "../../packages/address/external";
import { PRIVATE_KEY } from "../../Constant";
import { rawBlock } from "../../interfaces/Block";

const BLOCK_RAW_DATA = "eecbf284c5878916919198743ef8c1ab9aabd2bba6d486637312acd78b6f2cf50893a4c70e75ceec6505df8c788ae83f17b8220f9ab5565d816562502a6004d5007b226e6f6e6365223a312c227472616e73616374696f6e73223a5b7b2268617368223a2266663762663866323863616632663730333736613363656466353039313233643238323639323231626331643766363534336438633930633032316562613566222c2264617461223a2264643730366466323439356130376430396336386536373433386236666430643363366463313138373537623564393335353631333661363237613931616534326263373735336563643730653739643165386238666266613263643030666334316466383864333333336336356162663536326236376338303265663239323030376232323665366636653633363532323361323233303232326332323636363536353733346636363636363537323635363432323361333032653330333232633232363637323666366432323361323236363337333833373632333733343336333933383634363433343330333133363635363436353633333833353631333933323338333433353631333733343339333636363337333433323333363133383631363536363634363436333337333033303634333133313634363433343632323232633232373437393730363532323361323235343532343134653533343634353532323232633232373436663662363536653534373236313665373336363635373232323361356237623232373436663662363536653439363432323361323234343435343135323232326332323631366436663735366537343232336133353263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2264326463333231363233623630633261383962346533363931306533373461303430396361373061323838393039323865313832373437386462366135616334222c2264617461223a2239616330646637383639613133313665303039613464346534313133343862386139613437386230303633613038336531623662643630636461366365353635356463663139303565316164383237363665383932363731386433613234653761643536343730623137353064653230626235366435363035393661356437633030376232323665366636653633363532323361323233303232326332323636363536353733346636363636363537323635363432323361333032653330333232633232363637323666366432323361323236363337333833373632333733343336333933383634363433343330333133363635363436353633333833353631333933323338333433353631333733343339333636363337333433323333363133383631363536363634363436333337333033303634333133313634363433343632323232633232373437393730363532323361323235343532343134653533343634353532323232633232373436663662363536653534373236313665373336363635373232323361356237623232373436663662363536653439363432323361323234343435343135323232326332323631366436663735366537343232336133363263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2265363362333264613835356262663739383131333066663563343837333337366665363830653934366334646265646137383431646366636235373834393032222c2264617461223a2261343137376231666333323135626138396336356362343561626136613730623634333964383863353835656362363830333235393564393863316531306630333738366462353066396261333361626337333266376662623864346663343464383263633666616333383037326431326165386263353164616233343162663030376232323665366636653633363532323361323233303232326332323636363536353733346636363636363537323635363432323361333032653330333232633232363637323666366432323361323236363337333833373632333733343336333933383634363433343330333133363635363436353633333833353631333933323338333433353631333733343339333636363337333433323333363133383631363536363634363436333337333033303634333133313634363433343632323232633232373437393730363532323361323235343532343134653533343634353532323232633232373436663662363536653534373236313665373336363635373232323361356237623232373436663662363536653439363432323361323234343435343135323232326332323631366436663735366537343232336133373263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2266366232316538646538326337343830336535633831396466393863336434623962613563343933353633353535363866383530653334343430646139633731222c2264617461223a2231663066323265306335346335336237383236363332656433373231623732623137393736393463303439346339383631653765663239363633633838626130343638313237396233396338346638306665376532656564653637346562373362313862383831663935303138363064306566323333333031313237653934343031376232323665366636653633363532323361323233303232326332323636363536353733346636363636363537323635363432323361333032653330333232633232363637323666366432323361323236363337333833373632333733343336333933383634363433343330333133363635363436353633333833353631333933323338333433353631333733343339333636363337333433323333363133383631363536363634363436333337333033303634333133313634363433343632323232633232373437393730363532323361323235343532343134653533343634353532323232633232373436663662363536653534373236313665373336363635373232323361356237623232373436663662363536653439363432323361323234343435343135323232326332323631366436663735366537343232336133383263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2261653731646463623032316635616262643164363837313737613866396632323463346163333335316638666430643138316537323464356138303665613163222c2264617461223a2230643532346639323032383633323162383733376261333066313735313833376237623533343732663265323735613936353761316335303937613337313864373131323165646539646635303139653966383235383733303739613162303733303639616131316261336435373339613337613032353664323338383536323030376232323665366636653633363532323361323233303232326332323636363536353733346636363636363537323635363432323361333032653330333232633232363637323666366432323361323236363337333833373632333733343336333933383634363433343330333133363635363436353633333833353631333933323338333433353631333733343339333636363337333433323333363133383631363536363634363436333337333033303634333133313634363433343632323232633232373437393730363532323361323235343532343134653533343634353532323232633232373436663662363536653534373236313665373336363635373232323361356237623232373436663662363536653439363432323361323234343435343135323232326332323631366436663735366537343232336133393263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2266656262653231323630653435376436333164343563663465393739646538663333626563333830376231313262323339393361323133653731303437323339222c2264617461223a22353634336363643261353835343966623661373666343734363766663936656565313162666337303866366231646439346639343233316365623635653535613632663665643166343232663239376635303364646632393136373038336437393638383336333963613665633364333133306131316462623335353064623330303762323236653666366536333635323233613232333032323263323236363635363537333466363636363635373236353634323233613330326533303332326332323636373236663664323233613232363633373338333736323337333433363339333836343634333433303331333636353634363536333338333536313339333233383334333536313337333433393336363633373334333233333631333836313635363636343634363333373330333036343331333136343634333436323232326332323734373937303635323233613232353435323431346535333436343535323232326332323734366636623635366535343732363136653733363636353732323233613562376232323734366636623635366534393634323233613232343434353431353232323263323236313664366637353665373432323361333133303263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2266383438366335383233333331316338363365643235336165373838333637653061663933313139386635643230396437313763666566613334383966653438222c2264617461223a22656335363235613561386566386236356532316231633235313564356137393130393839356533343732633762363965376365663832393830656536383637663035633732626430346461623331666563373332616535633737313336353434336436626533356662363036343939373237613537643364623234633561363430313762323236653666366536333635323233613232333032323263323236363635363537333466363636363635373236353634323233613330326533303332326332323636373236663664323233613232363633373338333736323337333433363339333836343634333433303331333636353634363536333338333536313339333233383334333536313337333433393336363633373334333233333631333836313635363636343634363333373330333036343331333136343634333436323232326332323734373937303635323233613232353435323431346535333436343535323232326332323734366636623635366535343732363136653733363636353732323233613562376232323734366636623635366534393634323233613232343434353431353232323263323236313664366637353665373432323361333133313263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2262663238613334616263333063626636343762393638333730613766346666316664396230633434326635623061613662663766643836663466316436333234222c2264617461223a22336566383265633461653764656166666534306231366162636663616538653364356232333034613762613139633163663165306366363937383638663731653333393866633666373661663237303339653362663737666565363064646334343233373863386366376262373536326565623164363061366530373334303430313762323236653666366536333635323233613232333032323263323236363635363537333466363636363635373236353634323233613330326533303332326332323636373236663664323233613232363633373338333736323337333433363339333836343634333433303331333636353634363536333338333536313339333233383334333536313337333433393336363633373334333233333631333836313635363636343634363333373330333036343331333136343634333436323232326332323734373937303635323233613232353435323431346535333436343535323232326332323734366636623635366535343732363136653733363636353732323233613562376232323734366636623635366534393634323233613232343434353431353232323263323236313664366637353665373432323361333133323263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d2c7b2268617368223a2230616336646435346139363332393934376132386335323534366666393032653265663134626566326433316431326362626566346136333363393036643639222c2264617461223a22616561663361363839636634356632363965353366316438333334663938633165326666383762353061663565616632353965613066343438376633336233313137316535313637363138336337356634353839663636636564333863656530303033343866336238313939623361366531313039663364323833343333333730313762323236653666366536333635323233613232333032323263323236363635363537333466363636363635373236353634323233613330326533303332326332323636373236663664323233613232363633373338333736323337333433363339333836343634333433303331333636353634363536333338333536313339333233383334333536313337333433393336363633373334333233333631333836313635363636343634363333373330333036343331333136343634333436323232326332323734373937303635323233613232353435323431346535333436343535323232326332323734366636623635366535343732363136653733363636353732323233613562376232323734366636623635366534393634323233613232343434353431353232323263323236313664366637353665373432323361333133333263323237343666323233613232333436313336333833303335333033373331333433303330363136363634333336353336333136343338333236363636333936323331333133333632363233333336333733333336363233393636333333323331363336343331333033363631333436363337363233353337333133303232376435643263323236353738373437323631343436313734363132323361323232323764227d5d2c226e756d626572223a343034322c2276616c696461746f72223a226637383762373436393864643430313665646563383561393238343561373439366637343233613861656664646337303064313164643462222c22746f74616c436f6c6c656374656446656573223a302c22666565734275726e74223a302e3030312c2266656573546f44616f223a302e30312c2266656573546f56616c696461746f72223a302e30322c2266656573546f54786e56616c696461746f72223a302e30322c2270726576426c6f636b48617368223a22307831222c2274696d657374616d70223a313636323739373732373433367d"

export const isBlockValid = (rawBlockData: string) => {
  console.time("Block Validation Time")
  // const signedData = TransactionPoolDB;
  let signature = rawBlockData.slice(0, 128);
  let recId = rawBlockData.slice(128, 130);
  let blockdata = rawBlockData.slice(130, rawBlockData.length);
  // let fetchTxnData = []
  let block: rawBlock = JSON.parse(
    Buffer.from(blockdata, "hex").toString("ascii")
  );
  // console.log("blockData", block)
  for (let tx of block.transactions) {  //fetching Transaction Pool 
    const element = tx;
    const dataTxn = tx.data;
    if (dataTxn.length > 130) { // transaction pool signature check for block validation 
      let signature = dataTxn.slice(0, 128);
      let recId = dataTxn.slice(128, 130);
      let txnData = dataTxn.slice(130, dataTxn.length);
      let transaction: RawTransaction = JSON.parse(
        Buffer.from(txnData, "hex").toString("ascii")
      );
      // validateSignature(transaction, txnData, signature, recId);
      if (validateSignature(transaction, txnData, signature, recId) && validateTransfer(transaction)) {
        continue;
      }else{
        console.timeEnd("Block Validation Time");
        return false;
      }
    }
  }
  // let blockSignature = rawBlockData.slice(0, 128);
  // let blockRecId = rawBlockData.slice(128, 130);
  // let blockTxnData = rawBlockData.slice(130, rawBlockData.length);
  // let blockTransaction: RawTransaction = JSON.parse(
  //   Buffer.from(blockTxnData, "hex").toString("ascii")
  // );


  if (blockValidateSignature(blockdata, signature, recId)) {
    console.timeEnd("Block Validation Time");
    return true;
  }else {
    // console.log("Error: Validating Block ")
    console.timeEnd("Block Validation Time");
    return false;
  }
}


function blockValidateSignature(txData: string,
  signature: string,
  recId: string) {

  let txid = calculateHash(txData);
  let recoveredPublicKey = secp256k1.ecdsaRecover(
    Buffer.from(signature, "hex"),
    parseInt(recId, 16),
    Buffer.from(txid, "hex")
  );
  let address = getAddress(convertToHex(recoveredPublicKey));
  // console.log(
  //   secp256k1.ecdsaVerify(
  //     Buffer.from(signature, "hex"),
  //     Buffer.from(txid, "hex"),
  //     secp256k1.publicKeyCreate(Buffer.from(PRIVATE_KEY, "hex"))
  //   )
  // );
  console.log("Block RecoverAddress :", convertToHex(address));

  return address;
}


isBlockValid(BLOCK_RAW_DATA);

